generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

model User {
    id              String          @id @default(uuid())
    email           String          @unique
    password        String?
    displayName     String?
    role            String          @default("PARTNER") // PARTNER, SUPPORT, ADMIN
    partnerId       String?
    partner         Partner?        @relation(fields: [partnerId], references: [id])
    assignedTickets Ticket[]        @relation("AssignedStaff")
    serviceRecords  ServiceRecord[]
    calendarEvents  CalendarEvent[]
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
}

model Partner {
    id                  String          @id @default(uuid())
    // Login Info
    userPass            String?
    userEmail           String?
    // Business Info  
    companyName         String
    managementCompany   String?
    streetAddress       String?
    city                String?
    state               String?
    zip                 String?
    country             String?
    // LounGenie Info
    numberOfLoungeUnits Int             @default(0)
    topColour           String? // Classic Blue, Ice Blue, Ducati Red, Yellow, Other
    // Lock Info (Admin/Support only)
    lock                String?
    masterCode          String?
    subMasterCode       String?
    lockPart            String?
    key                 String?
    // Map Info
    latitude            Float?
    longitude           Float?
    // Relations
    users               User[]
    tickets             Ticket[]
    serviceRecords      ServiceRecord[]
    calendarEvents      CalendarEvent[]
    createdAt           DateTime        @default(now())
    updatedAt           DateTime        @updatedAt
}

model Ticket {
    id                String             @id @default(uuid())
    partnerId         String
    partner           Partner            @relation(fields: [partnerId], references: [id])
    // Submitter Info
    firstName         String?
    lastName          String?
    title             String?
    createdByName     String?
    // Ticket Details
    subject           String
    category          String             @default("General") // Call Button, Charging, Connectivity, Screen, Locking, General Maintenance, Monitor, Antenna, Gateway, LoRa, General System, Other
    description       String?
    unitsAffected     Int?
    priority          String             @default("MEDIUM") // LOW, MEDIUM, HIGH
    status            String             @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED
    contactPreference String?
    recurringIssue    Boolean            @default(false)
    dateOfOccurrence  DateTime?
    severity          Int? // 1-10 severity slider
    // Assignment & Internal
    assignedToId      String?
    assignedTo        User?              @relation("AssignedStaff", fields: [assignedToId], references: [id])
    internalNotes     String?
    followUpNotes     String?
    resolutionTime    Int? // minutes
    escalated         Boolean            @default(false)
    // Files & Attachments
    attachments       TicketAttachment[]
    createdAt         DateTime           @default(now())
    updatedAt         DateTime           @updatedAt

    @@index([partnerId, status])
    @@index([assignedToId])
    @@index([priority, status])
}

model TicketAttachment {
    id         String   @id @default(uuid())
    ticketId   String
    ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
    filename   String
    filepath   String
    mimetype   String
    size       Int
    uploadedAt DateTime @default(now())
}

model ServiceRecord {
    id            String    @id @default(uuid())
    partnerId     String
    partner       Partner   @relation(fields: [partnerId], references: [id])
    assignedToId  String?
    assignedTo    User?     @relation(fields: [assignedToId], references: [id])
    serviceType   String // Maintenance, Support, Upgrade, Installation, Training
    description   String?
    notes         String?
    scheduledDate DateTime?
    completedDate DateTime?
    status        String    @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
    attachments   String? // JSON array of file paths
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    @@index([partnerId])
    @@index([assignedToId])
}

model CalendarEvent {
    id              String    @id @default(uuid())
    partnerId       String
    partner         Partner   @relation(fields: [partnerId], references: [id])
    createdById     String?
    createdBy       User?     @relation(fields: [createdById], references: [id])
    title           String
    description     String?
    eventType       String // OPEN, CLOSED, MAINTENANCE, INSTALLATION, UPGRADE, TRAINING
    startDate       DateTime
    endDate         DateTime?
    isRecurring     Boolean   @default(false)
    recurrenceRule  String? // RRULE format for recurring events
    reminderMinutes Int? // Minutes before event to send reminder
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt

    @@index([partnerId])
    @@index([createdById])
}

model KnowledgeBase {
    id             String   @id @default(uuid())
    title          String
    content        String
    category       String // Maps to ticket categories
    tags           String? // JSON array of tags
    attachments    String? // JSON array of file paths
    videos         String? // JSON array of video URLs/paths
    searchKeywords String? // For search optimization
    viewCount      Int      @default(0)
    rating         Float? // Average user rating
    isPublished    Boolean  @default(true)
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
}

model Notification {
    id             String    @id @default(uuid())
    userId         String? // If null, it's a system-wide notification
    recipientEmail String?
    title          String
    message        String
    type           String // TICKET_UPDATE, ASSIGNMENT, CALENDAR_REMINDER, SYSTEM
    relatedId      String? // Related ticket/service/calendar ID
    relatedType    String? // TICKET, SERVICE, CALENDAR
    isRead         Boolean   @default(false)
    sentAt         DateTime?
    createdAt      DateTime  @default(now())

    @@index([userId])
    @@index([type])
    @@index([userId, isRead, createdAt])
}
