#!/usr/bin/env bash
set -euo pipefail
. "$(dirname -- "$0")/_/husky.sh"

START_TIME=$(date +%s)

# Bypass hooks logic
COMMIT_MSG_FILE="$(git rev-parse --git-path COMMIT_EDITMSG 2>/dev/null || echo .git/COMMIT_EDITMSG)"
if git rev-parse --verify HEAD >/dev/null 2>&1; then
	LAST_COMMIT_MSG=$(git log -1 --pretty=%B || echo "")
else
	LAST_COMMIT_MSG=""
fi

if git diff --cached --quiet; then
	echo "‚ö† No staged changes. Aborting commit." >&2
	exit 1
fi

RAW_MSG=$(if [ -f "$COMMIT_MSG_FILE" ]; then cat "$COMMIT_MSG_FILE"; else echo ""; fi | tr -d '\0')
if echo "$RAW_MSG" | grep -qi '\[skip hooks\]' || [ "${SKIP_HOOKS:-}" = "1" ]; then
	echo "‚è≠  Hooks skipped via flag ([skip hooks] or SKIP_HOOKS=1)."
	exit 0
fi

echo "üîé Running pre-commit quality checks..."

# Capture changed (staged) files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRT)

FILE_COUNT=$(echo "$CHANGED_FILES" | grep -c '.') || FILE_COUNT=0
if [ "$FILE_COUNT" -gt 200 ]; then
	echo "‚ö† Large commit ($FILE_COUNT files). Consider splitting for easier review." >&2
fi

# Warn about large individual files (>500KB newly added/modified)
while IFS= read -r f; do
	if [ -f "$f" ]; then
		SIZE=$(wc -c <"$f")
		if [ "$SIZE" -gt 512000 ]; then
			echo "‚ö† Large file staged: $f ($(printf '%.1f' "$(echo "$SIZE / 1024" | bc -l)") KB)" >&2
		fi
	fi
done <<EOF
$CHANGED_FILES
EOF

# Secret pattern scan (basic) - skip with SKIP_SECRET_SCAN=1
if [ "${SKIP_SECRET_SCAN:-}" != "1" ]; then
	echo "üîê Secret scan (basic patterns)"
	if echo "$CHANGED_FILES" | grep -E '\.(env|ini|cfg|conf|json|ya?ml)$' >/dev/null 2>&1; then
		if grep -EIHn '(aws_secret_access_key|-----BEGIN( RSA)? PRIVATE KEY-----|xox[baprs]-[0-9A-Za-z-]+|ghp_[0-9A-Za-z]{36}|AIza[0-9A-Za-z_-]{35})' $CHANGED_FILES 2>/dev/null; then
			echo "‚ùå Potential secret detected. Abort (set SKIP_SECRET_SCAN=1 to bypass if false positive)." >&2
			exit 1
		fi
	fi
fi

# Run lint-staged if available
if npx --no-install lint-staged >/dev/null 2>&1; then
	echo "üßπ Running lint-staged (format + eslint)"
	npx lint-staged || { echo "‚ùå lint-staged failed" >&2; exit 1; }
else
	echo "‚Ñπ lint-staged not installed or config missing; skipping its phase."
fi

BACKEND_CHANGED=$(echo "$CHANGED_FILES" | grep -E '^(backend/|backend\\\\)' || true)
FRONTEND_CHANGED=$(echo "$CHANGED_FILES" | grep -E '^(frontend/|frontend\\\\)' || true)

RUN_TESTS=true
if [ "${SKIP_TESTS:-}" = "1" ]; then
	RUN_TESTS=false
fi

# Only run tests if corresponding code changed
if $RUN_TESTS; then
	if [ -n "$BACKEND_CHANGED" ]; then
		echo "üß™ Backend tests (changed backend files detected)"
		(cd backend && npm run typecheck --silent && npm run test --silent)
	fi
	if [ -n "$FRONTEND_CHANGED" ]; then
		echo "üß™ Frontend tests (changed frontend files detected)"
		(cd frontend && npm run typecheck --silent && npm run test --silent)
	fi
	if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
		echo "‚Ñπ No backend/frontend source changes -> skipping heavy tests"
	fi
else
	echo "‚è≠ Tests skipped (SKIP_TESTS=1)"
fi

END_TIME=$(date +%s)
ELAPSED=$((END_TIME-START_TIME))
echo "‚úÖ Pre-commit checks completed in ${ELAPSED}s"
