name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Cache backend node_modules
      - name: Cache backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-node-modules-${{ runner.os }}-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            backend-node-modules-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Backend Pipeline
      - name: Install backend deps
        working-directory: backend
        run: npm ci
      - name: Lint backend
        working-directory: backend
        run: npm run lint
      - name: Type check backend
        working-directory: backend
        run: npm run typecheck
      - name: Test backend
        working-directory: backend
        run: npm test --silent
      - name: Build backend
        working-directory: backend
        run: npm run build

      # Cache frontend node_modules
      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            frontend-node-modules-

      # Frontend Pipeline
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci
      - name: Lint frontend
        working-directory: frontend
        run: npm run lint
      - name: Type check frontend
        working-directory: frontend
        run: npm run typecheck
      - name: Test frontend unit
        working-directory: frontend
        run: npm run test --silent

      # E2E Tests
      - name: Cypress e2e
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          install: false
          browser: chrome
          build: npm run build
          start: npm run preview -- --port 5173 --strictPort --host
          wait-on: "http://localhost:5173"
          wait-on-timeout: 120000
        env:
          CI: true

      # Upload Cypress screenshots and videos as artifacts
      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos
          if-no-files-found: ignore

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Check deploy secrets
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          missing=()
          [[ -z "$VPS_HOST" ]] && missing+=(VPS_HOST)
          [[ -z "$VPS_USER" ]] && missing+=(VPS_USER)
          [[ -z "$VPS_SSH_KEY" ]] && missing+=(VPS_SSH_KEY)
          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "Missing secrets: ${missing[*]}"
            exit 78 # neutral
          fi
      - name: Deploy to VPS with Blue-Green Strategy
        uses: appleboy/ssh-action@v1.0.3
        if: ${{ success() }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
            # Download enhanced deployment script if not exists
            if [[ ! -f /opt/deploy-blue-green.sh ]]; then
              echo "Downloading enhanced deployment script..."
              sudo curl -fsSL https://raw.githubusercontent.com/faith233525/Fatima-Pool-Safe-Inc-Portal-2025-Final-/main/deploy/deploy-blue-green.sh -o /opt/deploy-blue-green.sh
              sudo chmod +x /opt/deploy-blue-green.sh
            fi

            # Execute blue-green deployment
            echo "Starting blue-green deployment..."
            sudo /opt/deploy-blue-green.sh deploy

      - name: Deployment Status Check
        uses: appleboy/ssh-action@v1.0.3
        if: always()
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Check deployment status
            sudo /opt/deploy-blue-green.sh status

            # Perform final health check
            echo "Performing comprehensive health check..."
            sudo /opt/deploy-blue-green.sh health

            # Check system resources
            echo "üìä System Resource Status:"
            free -h
            df -h
            uptime

  notify:
    name: Notify Deployment Status
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Notify Success
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "Deployment completed successfully!"
          echo "See environment dashboard for details."

      - name: Notify Failure
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "‚ùå Deployment failed!"
          echo "üîÑ Automatic rollback should have been initiated"
          echo "üîç Check VPS logs for details"

      - name: Email Alert on Failure
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          # TODO: Add email sending script here

      # Optional: create an issue on failure (requires repo write token)
      - name: Open issue on failure
        if: ${{ needs.deploy.result == 'failure' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = context.repo;
            const title = 'Deployment failed';
            const body = `Deployment failed for commit ${context.sha} on ${context.ref}. Check Actions logs for details.`;
            await github.rest.issues.create({ owner: repo.owner, repo: repo.repo, title, body });
