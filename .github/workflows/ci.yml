name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Cache backend node_modules
      - name: Cache backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-node-modules-${{ runner.os }}-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            backend-node-modules-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Backend Pipeline
      - name: Install backend deps
        working-directory: backend
        run: npm ci
      - name: Lint backend
        working-directory: backend
        run: npm run lint
      - name: Type check backend
        working-directory: backend
        run: npm run typecheck
      - name: Test backend
        working-directory: backend
        run: npm test --silent
      - name: Build backend
        working-directory: backend
        run: npm run build

      # Cache frontend node_modules
      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            frontend-node-modules-

      # Frontend Pipeline
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci
      - name: Lint frontend
        working-directory: frontend
        run: npm run lint
      - name: Type check frontend
        working-directory: frontend
        run: npm run typecheck
      - name: Test frontend unit
        working-directory: frontend
        run: npm run test --silent


      # E2E Tests
      - name: Cypress e2e
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          install: false
          browser: chrome
          start: npm run dev
          wait-on: "http://localhost:5173"
        env:
          CI: true

      # Upload Cypress screenshots and videos as artifacts
      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos
          if-no-files-found: ignore

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy to VPS with Blue-Green Strategy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Download enhanced deployment script if not exists
            if [[ ! -f /opt/deploy-blue-green.sh ]]; then
              echo "üì• Downloading enhanced deployment script..."
              sudo curl -fsSL https://raw.githubusercontent.com/faith233525/Fatima-Pool-Safe-Inc-Portal-2025-Final-/main/deploy/deploy-blue-green.sh -o /opt/deploy-blue-green.sh
              sudo chmod +x /opt/deploy-blue-green.sh
            fi

            # Execute blue-green deployment
            echo "ÔøΩ Starting blue-green deployment..."
            sudo /opt/deploy-blue-green.sh deploy

      - name: Deployment Status Check
        uses: appleboy/ssh-action@v1.0.3
        if: always()
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Check deployment status
            sudo /opt/deploy-blue-green.sh status

            # Perform final health check
            echo "ÔøΩ Performing comprehensive health check..."
            sudo /opt/deploy-blue-green.sh health

            # Check system resources
            echo "üìä System Resource Status:"
            free -h
            df -h
            uptime

  notify:
    name: Notify Deployment Status
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Success
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Application URL: https://${{ secrets.VPS_HOST }}"
          echo "üìä Monitoring: https://${{ secrets.VPS_HOST }}/api/monitoring/dashboard"

      - name: Notify Failure
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "‚ùå Deployment failed!"
          echo "üîÑ Automatic rollback should have been initiated"
          echo "üîç Check VPS logs for details"

         - name: Email Alert on Failure
           if: ${{ needs.deploy.result == 'failure' }}
           run: |
             echo "Deployment failed for commit ${{ github.sha }} on branch ${{ github.ref }}. Check Actions for details." | mail -s "Pool Safe Inc Portal CI/CD Failure" ${{ secrets.ALERT_EMAIL }}

         - name: Email Alert on Failure
           if: ${{ needs.deploy.result == 'failure' }}
           uses: actions/github-script@v7
           with:
             script: |
               const subject = 'Pool Safe Inc Portal CI/CD Failure';
               const body = `Deployment failed for commit ${{ github.sha }} on branch ${{ github.ref }}.\nCheck Actions for details.`;
               require('child_process').execSync(`echo "${body}" | mail -s "${subject}" ${{ secrets.ALERT_EMAIL }}`);
